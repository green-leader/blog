<!doctype html><html lang=en><head><title>Usb Wake :: Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="When done working on my desktop I suspend it, either through the Cinnamon panel or via systemctl suspend. But it had an issue. I would frequently come downstairs to find it on. The monitors with their familiar glow lighting up the room. My desktop running Linux Mint had a problem. Some initial diagnosis lead me to finding out that the issue was that the keyboard and mouse, paired with the lovely kitties were waking it from it&amp;rsquo;s slumber."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.sions.org/posts/usb-wake/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=https://blog.sions.org/img/theme-colors/green.png><link rel=apple-touch-icon href=https://blog.sions.org/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Usb Wake"><meta property="og:description" content="When done working on my desktop I suspend it, either through the Cinnamon panel or via systemctl suspend. But it had an issue. I would frequently come downstairs to find it on. The monitors with their familiar glow lighting up the room. My desktop running Linux Mint had a problem. Some initial diagnosis lead me to finding out that the issue was that the keyboard and mouse, paired with the lovely kitties were waking it from it&amp;rsquo;s slumber."><meta property="og:url" content="https://blog.sions.org/posts/usb-wake/"><meta property="og:site_name" content="Blog"><meta property="og:image" content="https://blog.sions.org/img/favicon/green.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-07-16 08:00:00 +0000 UTC"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body class=green><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.sions.org/posts/usb-wake/>Usb Wake</a></h1><div class=post-meta><time class=post-date>2023-07-16 ::</time></div><span class=post-tags>#<a href=https://blog.sions.org/tags/system-administration/>System Administration</a>&nbsp;
#<a href=https://blog.sions.org/tags/ansible/>Ansible</a>&nbsp;
#<a href=https://blog.sions.org/tags/linux/>Linux</a>&nbsp;</span><div class=post-content><div><p>When done working on my desktop I suspend it, either through the Cinnamon panel or via <code>systemctl suspend</code>. But it had an issue. I would frequently come downstairs to find it on. The monitors with their familiar glow lighting up the room. My desktop running Linux Mint had a problem. Some initial diagnosis lead me to finding out that the issue was that the keyboard and mouse, paired with the lovely kitties were waking it from it&rsquo;s slumber.</p><p>After a bit of web searching I found a forum post <a href="https://forums.linuxmint.com/viewtopic.php?t=239133">https://forums.linuxmint.com/viewtopic.php?t=239133</a> that seems to have a similiar issue and a solution. I&rsquo;ve rewritten a little bit here with examples, ending with an Ansible playbook to resolve the issue (at least on my machine). Updating it for your own equipment is an exercise left fot the user.</p><p>We run <code>cat/proc/acpi/wakeup | grep enabled</code> to get a list of devices that can wake the computer.</p><p>Then cross-reference it with <code>lspci | grep USB</code> to get the PCI bus for the USB devices.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sion@sion-dlnx:~$ lspci | grep USB
</span></span><span style=display:flex><span>00:14.0 USB controller: Intel Corporation Cannon Lake PCH USB 3.1 xHCI Host Controller <span style=color:#f92672>(</span>rev 10<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>01:00.2 USB controller: NVIDIA Corporation TU116 USB 3.1 Host Controller <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>01:00.3 Serial bus controller: NVIDIA Corporation TU116 USB Type-C UCSI Controller <span style=color:#f92672>(</span>rev a1<span style=color:#f92672>)</span>
</span></span><span style=display:flex><span>sion@sion-dlnx:~$ cat /proc/acpi/wakeup | grep enabled
</span></span><span style=display:flex><span>PEG0	  S4	*enabled   pci:0000:00:01.0
</span></span><span style=display:flex><span>RP11	  S4	*enabled   pci:0000:00:1d.0
</span></span><span style=display:flex><span>GLAN	  S4	*enabled   pci:0000:00:1f.6
</span></span><span style=display:flex><span>XHC	  S4	*enabled   pci:0000:00:14.0
</span></span><span style=display:flex><span>AWAC	  S4	*enabled   platform:ACPI000E:00
</span></span></code></pre></div><p>Looking at this, we just need to disable <code>XHC</code> to get our intended result of preventing USB from waking the computer.</p><p>The linked forum post calls out adding <code>echo "EHC3" > /proc/acpi/wakeup</code> to <code>/etc/rc.local</code> for executing and adding it on system startup (replacing EHC3 with the actual device name).</p><p>rc.local is a file that&rsquo;s used with sysVinit systems, it would be executed last when changing runlevels. As it&rsquo;s more common to encounter systemd we need to use an alternative, creating a script and a matching systemd service.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sion@sion-dlnx:~/Toybox$ sudo chmod +x /usr/local/bin/customstartup.sh 
</span></span><span style=display:flex><span>sion@sion-dlnx:~/Toybox$ sudo cp customstartup.service /etc/systemd/system
</span></span></code></pre></div><p>After briefling installing them to make sure everything works I deleted them. Since I&rsquo;m also trying to use Ansible more I&rsquo;ll go ahead and create a playbook which handles this. Yes It should technically be a role, but at this point I only have a couple things that need to happen so they&rsquo;ll be playbooks and get converted to roles soon enough.</p><p>disable_usb_wake.sh</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>#!/bin/bash
</span></span></span><span style=display:flex><span><span style=color:#75715e></span>set -o errexit
</span></span><span style=display:flex><span>set -o nounset
</span></span><span style=display:flex><span>set -o pipefail
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#75715e>################################################################################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># Disable USB devices from waking computer</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>/usr/bin/systemd-cat -t <span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>$(</span>basename <span style=color:#e6db74>&#34;</span>$0<span style=color:#e6db74>&#34;</span><span style=color:#66d9ef>)</span><span style=color:#e6db74>&#34;</span> disabling <span style=color:#e6db74>&#39;XHC&#39;</span> device from waking computer
</span></span><span style=display:flex><span>echo <span style=color:#e6db74>&#34;XHC&#34;</span> &gt; /proc/acpi/wakeup
</span></span></code></pre></div><p>disable_usb_wake.service</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span><span style=color:#75715e>################################################################################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># disable_usb_wake.service</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This service unit is to disable USB devices from waking computer</span>
</span></span><span style=display:flex><span><span style=color:#75715e>#</span>
</span></span><span style=display:flex><span><span style=color:#75715e>################################################################################</span>
</span></span><span style=display:flex><span><span style=color:#75715e># This should be placed in /etc/systemd/system.</span>
</span></span><span style=display:flex><span><span style=color:#75715e>################################################################################</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Unit<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>Description<span style=color:#f92672>=</span>Runs /usr/local/bin/disable_usb_wake.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>  
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Service<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>ExecStart<span style=color:#f92672>=</span>/usr/local/bin/disable_usb_wake.sh
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>[</span>Install<span style=color:#f92672>]</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>WantedBy<span style=color:#f92672>=</span>multi-user.target
</span></span></code></pre></div><p>disable_usb_wake.yml</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span>---
</span></span><span style=display:flex><span>- <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install systemd service disabling USB waking computer</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>hosts</span>: <span style=color:#ae81ff>all</span>
</span></span><span style=display:flex><span>  <span style=color:#f92672>tasks</span>:
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install disable_usb_wake.sh script</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.copy</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>src</span>: <span style=color:#ae81ff>files/disable_usb_wake.sh</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/usr/local/bin/disable_usb_wake.sh</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0544&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Install disable_usb_wake service</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.copy</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>src</span>: <span style=color:#ae81ff>files/disable_usb_wake.service</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>dest</span>: <span style=color:#ae81ff>/etc/systemd/system/disable_usb_wake.service</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>mode</span>: <span style=color:#e6db74>&#34;0644&#34;</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>owner</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>group</span>: <span style=color:#ae81ff>root</span>
</span></span><span style=display:flex><span>    - <span style=color:#f92672>name</span>: <span style=color:#ae81ff>Start disable_usb_wake service</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>become</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>      <span style=color:#f92672>ansible.builtin.systemd</span>:
</span></span><span style=display:flex><span>        <span style=color:#f92672>enabled</span>: <span style=color:#66d9ef>true</span>
</span></span><span style=display:flex><span>        <span style=color:#f92672>name</span>: <span style=color:#ae81ff>disable_usb_wake</span>
</span></span></code></pre></div></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://blog.sions.org/posts/ansible-handler/><span class=button__icon>←</span>
<span class=button__text>Ansible Handler</span></a></span>
<span class="button next"><a href=https://blog.sions.org/posts/image-change/><span class=button__text>Image Change</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>