<!doctype html><html lang=en><head><title>Full Hd :: Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I woke up this morning to my RSS feed misbehaving. FreshRSS was popping up an error along the lines that it was unable to make an internet connection. This was a little odd as I was connected over the local network to the app. It was loading at all which meant it could connect. I won&amp;rsquo;t bore you with how I found the problem, but the root partition of the server was full."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.sions.org/posts/full-hd/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=https://blog.sions.org/img/theme-colors/green.png><link rel=apple-touch-icon href=https://blog.sions.org/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Full Hd"><meta property="og:description" content="I woke up this morning to my RSS feed misbehaving. FreshRSS was popping up an error along the lines that it was unable to make an internet connection. This was a little odd as I was connected over the local network to the app. It was loading at all which meant it could connect. I won&amp;rsquo;t bore you with how I found the problem, but the root partition of the server was full."><meta property="og:url" content="https://blog.sions.org/posts/full-hd/"><meta property="og:site_name" content="Blog"><meta property="og:image" content="https://blog.sions.org/img/favicon/green.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-03-20 08:00:00 +0000 UTC"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body class=green><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.sions.org/posts/full-hd/>Full Hd</a></h1><div class=post-meta><time class=post-date>2023-03-20 ::</time></div><span class=post-tags>#<a href=https://blog.sions.org/tags/system-administration/>System Administration</a>&nbsp;
#<a href=https://blog.sions.org/tags/docker/>Docker</a>&nbsp;
#<a href=https://blog.sions.org/tags/logging/>Logging</a>&nbsp;</span><div class=post-content><div><p>I woke up this morning to my RSS feed misbehaving. FreshRSS was popping up an error along the lines that it was unable to make an internet connection. This was a little odd as I was connected over the local network to the app. It was loading at all which meant it could connect. I won&rsquo;t bore you with how I found the problem, but the root partition of the server was full.</p><p>A full root partition can cause a wide array of problems. As there shouldn&rsquo;t be anything downloading to this partition it was well over what it should be. The root partition is located on a 112 GB SSD. so there&rsquo;s not a whole lot but after cleaning up space I found that I was using less than a quarter of the drive.</p><p>When the drive is full you need to prioritze geting any space. just so the system can start to breathe again.</p><p>As this is a docker host <code>docker system prune</code> is a great candidate. It only cleared off a few hundred megs but it did what it was supposed to in this instance. Now we can search down and track down what the issue is.</p><p><code>sudo du -hsx /* | sort -rh | head -n 5</code>
Couple things going on so lets break down the arguments
<code>du -hsx</code>:</p><ul><li><code>h</code>: Human readable output. As a lowly human just reading bytes is hard.</li><li><code>s</code>: summarize, just put the totals on everything that du is ran against.</li><li><code>x</code>: one-file-system. Don&rsquo;t leave the filesystem, as we are only looking at the root partiition we don&rsquo;t need to know about everything that&rsquo;s mounted within the <code>/</code> filesystem.</li></ul><p><code>sort -rh</code>:</p><ul><li><code>r</code>: Reverse. We want the big numbers first</li><li><code>h</code>: human-numeric-sort. We&rsquo;re using human numbers because we&rsquo;re human.</li></ul><p><code>head -n 10</code>:</p><ul><li><code>n</code>: Pretty simple, this is how many lines we want. By specifying a number we&rsquo;re not just using the default.</li></ul><p>And the output:</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>$ sudo du -hsx /* | sort -rh | head -n <span style=color:#ae81ff>5</span>
</span></span><span style=display:flex><span>86G     /var                               
</span></span><span style=display:flex><span>3.2G    /home                   
</span></span><span style=display:flex><span>2.0G    /usr
</span></span><span style=display:flex><span>81M     /boot                               
</span></span><span style=display:flex><span>3.9M    /etc
</span></span></code></pre></div><p>Well it&rsquo;s <code>/var</code> as a culprit. We can just run the same command but specifying the path so we can dig in and keep digging down to find where the issue is. I won&rsquo;t post the outputs but I&rsquo;ll give the commands:</p><ol><li><code>$ sudo du -hsx /var/* | sort -rh | head -n 5</code></li><li><code>$ sudo du -hsx /var/lib/* | sort -rh | head -n 5</code></li><li><code>$ sudo du -hsx /var/lib/docker/* | sort -rh | head -n 5</code></li><li><code>$ sudo du -hsx /var/lib/docker/containers/* | sort -rh | head -n 5</code></li></ol><p>And the output for that last command points where the culprit is, mainly this nifty line:<code>64G /var/lib/docker/containers/containers/c585fa6366ddbd90e8565e07797431deab5c86bd157f757317d3b0655c099562</code></p><p>Looking a bit further (I forgot to grab logs of my commands) we can see that the container log(s) is a single 63 gig file. Whelp. There&rsquo;s the problem. A single docker container log is eating up 64 gigs of data, probaly bad configuration on my part. Using <code>docker inspect</code> we can find out which container was badly configured. Ended up being my borgmatic container, which has been running daily for over a month. Great! A log file is an easy fix! We just need to implement log rotation.</p><p>Couple different ways we can do it.</p><ul><li>logrotate daemon</li><li>docker daemon log-driver settings</li></ul><p>The docker daemon is probably a little easier to configure, but I&rsquo;m also just more comfortable with it. Setting defaults on the docker stuff is primarily done via the config file which on a linux system is at <code>/etc/docker/daemon.json</code>. This file may need to be created, and we&rsquo;ll do so putting the below into the file. Updating this file and restarting the service via <code>sudo systemctl restart docker.service</code> will cause any new container to use these new logging driver settings. As this isn&rsquo;t a new container we&rsquo;ll just use <code>docker-compose down</code> followed by <code>docker-compose up -d</code> on the compose file with the culprit container.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-json data-lang=json><span style=display:flex><span>{
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;log-driver&#34;</span>: <span style=color:#e6db74>&#34;local&#34;</span>,
</span></span><span style=display:flex><span>  <span style=color:#f92672>&#34;log-opts&#34;</span>: {
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;max-size&#34;</span>: <span style=color:#e6db74>&#34;15m&#34;</span>,
</span></span><span style=display:flex><span>    <span style=color:#f92672>&#34;max-file&#34;</span>: <span style=color:#e6db74>&#34;5&#34;</span>
</span></span><span style=display:flex><span>  }
</span></span><span style=display:flex><span>}
</span></span></code></pre></div><p>After updating these settings we can see that was the issue <code>df -h</code> is now reporting that the root partition is at 27G which is much much better. Should figure out how to send logs to splunk. Though I&rsquo;m not sure I like using splunk. We should also set up monitoring to get a notification when we get close to filling the drive again.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://blog.sions.org/posts/boring-week/><span class=button__text>I got my Network+ last week</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>