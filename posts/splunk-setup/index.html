<!doctype html><html lang=en><head><title>Splunk Setup :: Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I set up a splunk docker container recently and there were a couple what feel like oddities catching me up.
Default debian doesn&amp;rsquo;t have world readable log files. This is not for production. But it&amp;rsquo;s okay for my homelab. Starting with this basic docker-compose file we made sure it worked.
version: &amp;#34;3.6&amp;#34; services: so1: image: ${SPLUNK_IMAGE:-splunk/splunk:latest} container_name: so1 environment: - SPLUNK_START_ARGS=--accept-license - SPLUNK_PASSWORD ports: - 8000:8000 It&amp;rsquo;s simple, gets everything running without doing anything fancy."><meta name=keywords content="splunk,system administration,docker,linux"><meta name=robots content="noodp"><link rel=canonical href=https://blog.sions.org/posts/splunk-setup/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=https://blog.sions.org/img/theme-colors/green.png><link rel=apple-touch-icon href=https://blog.sions.org/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Splunk Setup"><meta property="og:description" content="I set up a splunk docker container recently and there were a couple what feel like oddities catching me up.
Default debian doesn&amp;rsquo;t have world readable log files. This is not for production. But it&amp;rsquo;s okay for my homelab. Starting with this basic docker-compose file we made sure it worked.
version: &amp;#34;3.6&amp;#34; services: so1: image: ${SPLUNK_IMAGE:-splunk/splunk:latest} container_name: so1 environment: - SPLUNK_START_ARGS=--accept-license - SPLUNK_PASSWORD ports: - 8000:8000 It&amp;rsquo;s simple, gets everything running without doing anything fancy."><meta property="og:url" content="https://blog.sions.org/posts/splunk-setup/"><meta property="og:site_name" content="Blog"><meta property="og:image" content="https://blog.sions.org/img/favicon/green.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2023-02-20 03:24:33 +0000 UTC"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body class=green><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.sions.org/posts/splunk-setup/>Splunk Setup</a></h1><div class=post-meta><time class=post-date>2023-02-20 ::</time></div><span class=post-tags>#<a href=https://blog.sions.org/tags/splunk/>splunk</a>&nbsp;
#<a href=https://blog.sions.org/tags/system-administration/>system administration</a>&nbsp;
#<a href=https://blog.sions.org/tags/docker/>docker</a>&nbsp;
#<a href=https://blog.sions.org/tags/linux/>linux</a>&nbsp;</span><div class=post-content><div><p>I set up a splunk docker container recently and there were a couple what feel like oddities catching me up.</p><ol><li>Default debian doesn&rsquo;t have world readable log files.</li><li>This is not for production. But it&rsquo;s okay for my homelab.</li></ol><p>Starting with this basic docker-compose file we made sure it worked.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.6&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>so1</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>${SPLUNK_IMAGE:-splunk/splunk:latest}</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>so1</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SPLUNK_START_ARGS=--accept-license</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SPLUNK_PASSWORD</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8000</span>:<span style=color:#ae81ff>8000</span>
</span></span></code></pre></div><p>It&rsquo;s simple, gets everything running without doing anything fancy. Let&rsquo;s iterate it fancier and match the style of the rest of my compose files.</p><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=display:flex><span><span style=color:#f92672>version</span>: <span style=color:#e6db74>&#34;3.6&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>services</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>splunk</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>image</span>: <span style=color:#ae81ff>splunk/splunk:latest</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>container_name</span>: <span style=color:#ae81ff>splunk</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>env_file</span>: <span style=color:#ae81ff>.env</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>environment</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>SPLUNK_START_ARGS=--accept-license</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>splunk_config:/opt/splunk/etc</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>splunk_data:/opt/splunk/var</span>
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>/var/log:/host/var/log:ro</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>ports</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>8000</span>:<span style=color:#ae81ff>8000</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>restart</span>: <span style=color:#ae81ff>unless-stopped</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>      - <span style=color:#ae81ff>mgmt_network</span>
</span></span><span style=display:flex><span>    <span style=color:#f92672>labels</span>:
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.enable=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.splunk-http.entrypoints=web&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.splunk-http.rule=Host(`splunk.${DOMAIN}`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.splunk-http.middlewares=splunk-https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.middlewares.splunk-https.redirectscheme.scheme=https&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.splunk.entrypoints=websecure&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.splunk.rule=Host(`splunk.${DOMAIN}`)&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.splunk.tls=true&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.routers.secwhoami.tls.certresolver=myresolver&#34;</span>
</span></span><span style=display:flex><span>      - <span style=color:#e6db74>&#34;traefik.http.services.splunk.loadbalancer.server.port=8000&#34;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>volumes</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>splunk_config</span>: {}
</span></span><span style=display:flex><span>  <span style=color:#f92672>splunk_data</span>: {}
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#f92672>networks</span>:
</span></span><span style=display:flex><span>  <span style=color:#f92672>mgmt_network</span>:
</span></span><span style=display:flex><span>    <span style=color:#f92672>external</span>: <span style=color:#66d9ef>true</span>
</span></span></code></pre></div><p>This is what we end up with after a couple iterations. But largely it matches the style and layout of the rest of my compose files. Three large changes:</p><ol><li>I&rsquo;ve moved the splunk password out of the compose file to a .env file (which gets encrypted for storing in git)</li><li>Added data persistence</li><li>Added Traefik labels, and network traefik watches</li></ol><p>There was a slight problem once this was done, all of the files in <code>/var/log</code> aren&rsquo;t world readable. After a bit of searching we come across the splunk community forums detailing a similar issue <a href=https://community.splunk.com/t5/Security/How-to-monitor-root-owned-logs-while-running-Splunk-as-a-non/td-p/16594>community.splunk.com</a> while this isn&rsquo;t a docker solution it&rsquo;s a solution to the problem. If not the most docker centric approach it beats setting up a universal forwarder to get files to the same machine.</p><p>Boiling it down we need to install acl controls, create a splunk user on the host, set up a logrotate rule file.</p><h2 id=accomplishing-1-and-2>Accomplishing 1 and 2:<a href=#accomplishing-1-and-2 class=hanchor arialabel=Anchor>&#8983;</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>sudo apt install acl
</span></span><span style=display:flex><span>sudo groupadd -g <span style=color:#ae81ff>41812</span> splunk
</span></span><span style=display:flex><span>sudo adduser --uid <span style=color:#ae81ff>41812</span> splunk --shell /sbin/nologin --system --no-create-home --gid <span style=color:#ae81ff>41812</span>
</span></span></code></pre></div><p>Notice we created a group then created the user. The version of debian I was running with the version of adduser I had wasn&rsquo;t permitting to explicity specify that I needed a primary group matching the user. Making the user on its own was causing the user to get put in a group &ldquo;nogroup&rdquo;. Probably user error.</p><h2 id=accomplishing-number-3>Accomplishing number 3:<a href=#accomplishing-number-3 class=hanchor arialabel=Anchor>&#8983;</a></h2><div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=display:flex><span>cat /etc/logrotate.d/Splunk_ACLs
</span></span><span style=display:flex><span>/var/log/splunklog
</span></span><span style=display:flex><span><span style=color:#f92672>{</span>
</span></span><span style=display:flex><span>    postrotate
</span></span><span style=display:flex><span>        /usr/bin/setfacl -m g:splunk:r /var/log/auth.log
</span></span><span style=display:flex><span>        /usr/bin/setfacl -m g:splunk:r /var/log/messages
</span></span><span style=display:flex><span>        /usr/bin/setfacl -m g:splunk:r /var/log/syslog
</span></span><span style=display:flex><span>    endscript
</span></span><span style=display:flex><span><span style=color:#f92672>}</span>
</span></span></code></pre></div><p>Understanding this fully needs a bit of background.</p><h3 id=logrotate>logrotate<a href=#logrotate class=hanchor arialabel=Anchor>&#8983;</a></h3><p>As a broad stroke logrotate has a simple task. Keep files manageable.</p><p>logrotate performs this function through keeping track of the size of the file, or at regular intervals renames the file adding a <code>.#</code> onto the end of the filename. The tool is capable of much more but we don&rsquo;t want to delve too far into that.</p><p>The directory <code>/etc/logrotate.d/</code> is charged with holding different configurations for various packages. In this case we&rsquo;ve both created a dummy file <code>/var/log/splunklog</code> and listed various rules on how logrotate should interact with that file. By default this file will be run daily as the root user.</p><h3 id=file-acls>File ACLs<a href=#file-acls class=hanchor arialabel=Anchor>&#8983;</a></h3><p>The keywords <code>postrotate</code> and <code>endscript</code> desginate a block of actions that should be perfomed when the file <code>Splunk_ACLs</code> is executed daily. This helps ensure that the specified actions are maintained on the specific files listed.</p><p>Lets break down the line(s) <code>/usr/bin/setfacl -m g:splunk:r /var/log/auth.log</code></p><ul><li><code>/usr/bin/setfacl</code> is a command with the sole purpose of setting linux file ACL rules.</li><li><code>-m</code> modify the rules on the designated file</li><li><code>g:splunk:r</code> pretty simple. This is where we specify new rules that should be active on the file. <code>:</code> is a delimiter splitting this into a three part spec.</li></ul><p>that spec reads as follows:</p><ul><li><code>g</code> says that the following piece will be either a gid or a group name.</li><li><code>splunk</code> the name of the group, we&rsquo;re opting for readability by using a group name.</li><li><code>r</code> the octal or relative form, if using relative any of <code>rwx</code> can be used, we&rsquo;ll be opting for read-only for logs in this case.</li></ul></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://blog.sions.org/posts/an-entry/><span class=button__text>An Entry</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2023 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>