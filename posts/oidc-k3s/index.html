<!doctype html><html lang=en><head><title>OIDC with K3s :: Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="I want to authenticate to work on my kubernetes (k3s) cluster not for any particular reason but specifically for knowledges sake. Following this I was able to get most of the way but there were a couple caveats and it doesn&amp;rsquo;t seem to be documented that many places. I&amp;rsquo;m not sure if it&amp;rsquo;s because it&amp;rsquo;s a bare metal situation and most k8 clusters are run on hyperscalers or if it&amp;rsquo;s just not something that&amp;rsquo;s usually done."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.sions.org/posts/oidc-k3s/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=https://blog.sions.org/img/theme-colors/green.png><link rel=apple-touch-icon href=https://blog.sions.org/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="OIDC with K3s"><meta property="og:description" content="I want to authenticate to work on my kubernetes (k3s) cluster not for any particular reason but specifically for knowledges sake. Following this I was able to get most of the way but there were a couple caveats and it doesn&amp;rsquo;t seem to be documented that many places. I&amp;rsquo;m not sure if it&amp;rsquo;s because it&amp;rsquo;s a bare metal situation and most k8 clusters are run on hyperscalers or if it&amp;rsquo;s just not something that&amp;rsquo;s usually done."><meta property="og:url" content="https://blog.sions.org/posts/oidc-k3s/"><meta property="og:site_name" content="Blog"><meta property="og:image" content="https://blog.sions.org/img/favicon/green.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2024-12-31 08:00:00 +0000 UTC"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body class=green><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.sions.org/posts/oidc-k3s/>OIDC with K3s</a></h1><div class=post-meta><time class=post-date>2024-12-31 ::</time></div><span class=post-tags>#<a href=https://blog.sions.org/tags/system-administration/>System Administration</a>&nbsp;
#<a href=https://blog.sions.org/tags/sso/>SSO</a>&nbsp;
#<a href=https://blog.sions.org/tags/k3s/>K3s</a>&nbsp;
#<a href=https://blog.sions.org/tags/kubernetes/>Kubernetes</a>&nbsp;
#<a href=https://blog.sions.org/tags/authentik/>Authentik</a>&nbsp;</span><div class=post-content><div><p>I want to authenticate to work on my kubernetes (k3s) cluster not for any particular reason but specifically for knowledges sake. Following this I was able to get most of the way but there were a couple caveats and it doesn&rsquo;t seem to be documented that many places. I&rsquo;m not sure if it&rsquo;s because it&rsquo;s a bare metal situation and most k8 clusters are run on hyperscalers or if it&rsquo;s just not something that&rsquo;s usually done.</p><p>Following this handy guide from FunkyPenguin I was able to get most of the way, I&rsquo;ll need to do a pul request and try to get it updated. <a href=https://geek-cookbook.funkypenguin.co.nz/kubernetes/oidc-authentication/k3s-authentik/>geek-cookbook.funkypenguin.co.nz/kubernetes/oidc-authentication/k3s-authentik/</a></p><p>There were a couple things that were catching me up. This might be a rehashing of the entire page, but when I had to rebuild the cluster I did get caught again and needed to do digging.</p><p>Within Authentik you&rsquo;ll need to create an application, provider, and group. Attach the group to your testing user. These are the redirect URI&rsquo;s you&rsquo;ll need to supply</p><pre tabindex=0><code>strict: http://localhost:8000
strict: http://localhost:18000
</code></pre><p>This will need to be added to the end of the k3s config file for all of the control-plane masters. <code>/etc/rancher/k3s/config.yaml</code></p><pre tabindex=0><code>kube-apiserver-arg:
  - &#34;oidc-issuer-url=&lt;application URL from authentik&gt;&#34;
  - &#34;oidc-client-id=kube-apiserver&#34;
  - &#34;oidc-username-claim=email&#34;
  - &#34;oidc-groups-claim=groups&#34;
  - &#34;oidc-username-prefix=oidc:&#34;
  - &#34;oidc-groups-prefix=oidc:&#34;
</code></pre><p>Of note the original guide does not have the last two lines defining the prefix. After the addition has been made to the control-plane masters k3s will need to be restarted <code>systemctl restart k3s</code>.</p><p>on the client devices <a href=https://github.com/int128/kubelogin>github.com/int128/kubelogin</a> will need to be installed and placed into the path.</p><p>run a test using <code>kubectl oidc-login setup --oidc-issuer-url=&lt;application URL from authentik> --oidc-client-id=kube-apiserver --oidc-client-secret=&lt;your secret> --oidc-extra-scope=profile,email</code></p><p>There will be several things that return. Of primary interest is the second step. Which should return a list of groups. If groups are not returned you will need to verify the groups claim is supplied in the config file and the profile scope is requested with the token.</p><p>Looking to step 5 &ldquo;Set up the kubeconfig&rdquo; we can run that command to finish setting up the local client. This command can be run as given with no adjustments.</p><p>Turning back to cluster configuration we will need to create a clusterrolebinding. This will create an immutable resource binding the <code>admin-kube-apiserver</code> group (authentik) to a <code>cluster-admin</code> as this is the highest privilege and permission this is far from ideal so this will need to be pared down. But for instructional purposes and to get initially running it will suffice. When adjusting groups within Authentik if you need to change what user is logged in without waiting for a timeout to occur you can delete the directory <code>~/.kube/cache</code>.</p><pre tabindex=0><code>kind: ClusterRoleBinding
apiVersion: rbac.authorization.k8s.io/v1
metadata:
  name: oidc-group-admin-kube-apiserver
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: cluster-admin 
subjects:
- kind: Group
  name: oidc:admin-kube-apiserver
</code></pre><p>As I use flux I create the file and put it into the git repository and wait for it to populate. Doing a check at this point should be successful <code>kubectl --user=oidc get nodes</code>. If it works you can set it as the default using <code>kubectl config set-context --current --user=oidc</code>. If you would like to delete the default cluster-admin level of config and have a mandatory login you can delete the default user with <code>kubectl config delete-user default</code> if you have a break-glass measure to login this should be fine.</p></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button previous"><a href=https://blog.sions.org/posts/authentik-proxy/><span class=button__icon>←</span>
<span class=button__text>Authentik Proxy</span></a></span>
<span class="button next"><a href=https://blog.sions.org/posts/powershell-notes/><span class=button__text>Notes on Powershell</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>