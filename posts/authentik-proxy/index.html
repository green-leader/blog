<!doctype html><html lang=en><head><title>Authentik Proxy :: Blog</title><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Setting up a page to authenticate and protect an unauthenticated page using Authentik, from a kubernetes cluster isn&amp;rsquo;t as well documented if your primary ingress is nginx. Traefik seems to be more popular and better documented. Authentik does have some documentation but there are a couple clarifying steps missing.
docs.goauthentik.io/docs/add-secure-apps/providers/proxy/server_nginx
For starters, create the group that will be assigned the app, users do not need to be assigned yet. Then create an application and a provider using the Wizard."><meta name=keywords content><meta name=robots content="noodp"><link rel=canonical href=https://blog.sions.org/posts/authentik-proxy/><link rel=stylesheet href=/style.css><link rel="shortcut icon" href=https://blog.sions.org/img/theme-colors/green.png><link rel=apple-touch-icon href=https://blog.sions.org/img/theme-colors/green.png><meta name=twitter:card content="summary"><meta property="og:locale" content="en"><meta property="og:type" content="article"><meta property="og:title" content="Authentik Proxy"><meta property="og:description" content="Setting up a page to authenticate and protect an unauthenticated page using Authentik, from a kubernetes cluster isn&amp;rsquo;t as well documented if your primary ingress is nginx. Traefik seems to be more popular and better documented. Authentik does have some documentation but there are a couple clarifying steps missing.
docs.goauthentik.io/docs/add-secure-apps/providers/proxy/server_nginx
For starters, create the group that will be assigned the app, users do not need to be assigned yet. Then create an application and a provider using the Wizard."><meta property="og:url" content="https://blog.sions.org/posts/authentik-proxy/"><meta property="og:site_name" content="Blog"><meta property="og:image" content="https://blog.sions.org/img/favicon/green.png"><meta property="og:image:width" content="1200"><meta property="og:image:height" content="627"><meta property="article:published_time" content="2025-01-01 08:00:00 +0000 UTC"><link rel=apple-touch-icon sizes=180x180 href=/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=/favicon-16x16.png><link rel=manifest href=/site.webmanifest></head><body class=green><div class="container headings--one-size"><header class=header><div class=header__inner><div class=header__logo><a href=/><div class=logo>Terminal</div></a></div><ul class="menu menu--mobile"><li class=menu__trigger>Menu&nbsp;▾</li><li><ul class=menu__dropdown><li><a href=/about>About</a></li></ul></li></ul></div><nav class=navigation-menu><ul class="navigation-menu__inner menu--desktop"><li><a href=/about>About</a></li></ul></nav></header><div class=content><article class=post><h1 class=post-title><a href=https://blog.sions.org/posts/authentik-proxy/>Authentik Proxy</a></h1><div class=post-meta><time class=post-date>2025-01-01 ::</time></div><span class=post-tags>#<a href=https://blog.sions.org/tags/></a>&nbsp;
#<a href=https://blog.sions.org/tags/></a>&nbsp;</span><div class=post-content><div><p>Setting up a page to authenticate and protect an unauthenticated page using Authentik, from a kubernetes cluster isn&rsquo;t as well documented if your primary ingress is nginx. Traefik seems to be more popular and better documented. Authentik does have some documentation but there are a couple clarifying steps missing.</p><p><a href=https://docs.goauthentik.io/docs/add-secure-apps/providers/proxy/server_nginx>docs.goauthentik.io/docs/add-secure-apps/providers/proxy/server_nginx</a></p><p>For starters, create the group that will be assigned the app, users do not need to be assigned yet. Then create an application and a provider using the Wizard. We can use the embedded outpost that&rsquo;s provided alongside the Authentik helm install. When supplying details on the Provider, &ldquo;Advanced flow Settings->Authentication flow&rdquo; should be set. While still within Authentik&rsquo;s admin panel we need to add the application in question to the outpost that will be used or create a new one as needed.</p><p>This will prevent receving a 500 error as a client from the nginx logs and a 404 error from the authentik logs. Doing this would have allowed me to receive an actual informative error of not being authenticated.</p><p>Create the ingress resource. There are two ingresses in play with this setup. The first is the authentication layer and the second is the ingress attached directly to the service that needs to be protected. This ingress needs to have HTTPS enabled on it so that will need to be specified. Here&rsquo;s an example ingress for the outpost. In this case <code>app.company</code> is the external URL for the resource that needs to be protected. We are also poitning it at the service of the outpost we are using.</p><pre tabindex=0><code>apiVersion: networking.k8s.io/v1
kind: Ingress
metadata:
  name: authentik-outpost
  namespace: authentik
spec:
  ingressClassName: nginx
  rules:
    - host: app.company
      http:
        paths:
          - path: /outpost.goauthentik.io
            pathType: Prefix
            backend:
              # Or, to use an external Outpost, create an ExternalName service and reference that here.
              # See https://kubernetes.io/docs/concepts/services-networking/service/#externalname
              service:
                name: ak-outpost-authentik-embedded-outpost
                port:
                  number: 9000
  tls:
    - hosts:
        - app.company
      secretName: production-tls-certificate
</code></pre><p>Initial troubleshooting also pointed at the ingress we created as being incorrectly named. Additionally we were also not correctly setting the tls keys on the ingress. the combination of both meant that <code>curl -i https://app.company/outpost.goauthentik.io/ping</code> would not return <code>HTTP/2 204</code> as intended. This secondary ingress only functions for the <code>/outpost.goauthentik.io/ping</code> path suffix.</p><p>Almost there. Now we need to go to or create the ingress resource that directly points at the service we are needing. These lines in the documentation are 1 for 1 what needs to be put in without any notes.</p><pre tabindex=0><code>metadata:
  annotations:
    # This should be the in-cluster DNS name for the authentik outpost service
    # as when the external URL is specified here, nginx will overwrite some crucial headers
    nginx.ingress.kubernetes.io/auth-url: |-
      http://ak-outpost-authentik-embedded-outpost.authentik.svc.cluster.local:9000/outpost.goauthentik.io/auth/nginx
    # If you&#39;re using domain-level auth, use the authentication URL instead of the application URL
    nginx.ingress.kubernetes.io/auth-signin: |-
      https://app.company/outpost.goauthentik.io/start?rd=$scheme://$http_host$escaped_request_uri
    nginx.ingress.kubernetes.io/auth-response-headers: |-
      Set-Cookie,X-authentik-username,X-authentik-groups,X-authentik-entitlements,X-authentik-email,X-authentik-name,X-authentik-uid
    nginx.ingress.kubernetes.io/auth-snippet: |
      proxy_set_header X-Forwarded-Host $http_host;
</code></pre></div></div><div class=pagination><div class=pagination__title><span class=pagination__title-h>Read other posts</span><hr></div><div class=pagination__buttons><span class="button next"><a href=https://blog.sions.org/posts/oidc-k3s/><span class=button__text>OIDC with K3s</span>
<span class=button__icon>→</span></a></span></div></div></article></div><footer class=footer><div class=footer__inner><div class=copyright><span>© 2025 Powered by <a href=http://gohugo.io>Hugo</a></span>
<span>:: Theme made by <a href=https://twitter.com/panr>panr</a></span></div></div></footer><script type=text/javascript src=/bundle.min.js></script></div></body></html>